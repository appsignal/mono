---
version: v1.0
name: Mono
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
auto_cancel:
  running:
    when: branch != 'main' AND branch != 'develop'
global_job_config:
  env_vars:
  - name: _BUNDLER_CACHE
    value: v1
  - name: _GEMS_CACHE
    value: v1
  - name: _BUNDLER_PATH
    value: vendor/bundle
  - name: RUNNING_IN_CI
    value: 'true'
  prologue:
    commands:
    - checkout
    - sem-version ruby 2.7.3
    - sem-version erlang 23.3
    - sem-version elixir 1.11.3
    - cache restore $_BUNDLER_CACHE-bundler-$(checksum Gemfile)
    - cache restore $_GEMS_CACHE-gems-$(checksum Gemfile)

    - npm install -g npm # TODO: temporary. Currently expected in the tests.
    - bundle config set retry 3
    - bundle config set jobs 3
    - bundle config set path $_BUNDLER_PATH
    - bundle config set clean 'true'
    - bundle install

    - git config --global init.defaultBranch main
    - git config --global user.email "example@example.com"
    - git config --global user.name "Example user"
  epilogue:
    on_pass:
      commands:
      - cache store $_BUNDLER_CACHE-bundler-$(checksum Gemfile) $_BUNDLER_PATH
      - cache store $_GEMS_CACHE-gems-$(checksum Gemfile) $HOME/.gem
blocks:
- name: Linters
  dependencies: []
  task:
    jobs:
    - name: RuboCop
      commands:
      - bundle exec rubocop
- name: Tests
  dependencies: []
  task:
    jobs:
    - name: RSpec
      commands:
      - bundle exec rspec
